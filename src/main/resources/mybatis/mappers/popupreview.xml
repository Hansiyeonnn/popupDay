<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="flower.popupday.popup_review.dao.PopupReviewDAO">

    <resultMap type="flower.popupday.popup_review.dto.PopupReviewDTO" id="popupReviewResultMap">
        <result property="popup_comment_id" column="popup_comment_id" />
        <result property="user_id" column="user_id"/>
        <result property="popup_id" column="popup_id"/>
        <result property="content" column="content"/>
        <result property="created_at" column="created_at"/>
        <result property="updated_at" column="updated_at"/>
        <result property="user_nickname" column="user_nickname"/>
    </resultMap>

    <!-- 리뷰 삽입 -->
    <insert id="addReview">
        INSERT INTO popup_comment_tbl (user_id, popup_id, content, created_at, updated_at)
        VALUES (#{user_id}, #{popup_id}, #{content}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>

    <!-- 특정 팝업 ID에 해당하는 리뷰 목록 조회 -->
    <select id="selectReviewsByPopupId" resultMap="popupReviewResultMap">
        SELECT pc.popup_comment_id,
               pc.content,
               pc.created_at,
               u.user_nickname,
               p.title AS popup_title
        FROM popup_comment_tbl pc
                 JOIN user_tbl u ON pc.user_id = u.id
                 JOIN popup_tbl p ON pc.popup_id = p.popup_id
        WHERE p.popup_id = #{popup_id}
        ORDER BY pc.created_at DESC;
    </select>

</mapper>