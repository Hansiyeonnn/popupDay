<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="flower.popupday.business.dao.StatsDAO">

    <resultMap id="visitResult" type="statsDTO">
        <result property="hits_id" column="hits_id"/>
        <result property="user_id" column="user_id"/>
        <result property="popup_id" column="popup_id"/>
        <result property="viewed_at" column="viewed_at"/>
    </resultMap>

    <resultMap id="visitCount" type="hitsDTO">
        <result property="month" column="month"/>
        <result property="result_count" column="result_count"/>
    </resultMap>

<!--    <select id="statsList" parameterType="long">-->
<!--        select * from hits_tbl where popup_id = #{popup_id}-->
<!--    </select>-->

    <select id="statsCount" parameterType="long" resultMap="visitCount">
        SELECT DATE_FORMAT(viewed_at, '%Y-%m') AS month, COUNT(*) AS hit_count
        FROM hits_tbl WHERE popup_id = #{popup_id}
        GROUP BY month ORDER BY month;
    </select>

    <insert id="updateHitUser" parameterType="long">
        insert into hits_tbl(user_id,popup_id,viewed_at) values(#{id},#{popup_id},now())
    </insert>

    <select id="userStats" parameterType="long" resultType="userStatsDTO">
        SELECT hit.user_id, hit.popup_id, hit.viewed_at, me.id, me.birth_date, me.gender
        from hits_tbl as hit left outer join user_tbl as me on hit.user_id = me.id WHERE popup_id = #{popup_id}
    </select>
</mapper>